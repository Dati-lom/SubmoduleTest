name: Find Repos using Submodule
on:
  workflow_dispatch:
    inputs:
      submodule_repo:
        description: "The owner/repo name of the submodule to search for (e.g., my-org/shared-library)"
        required: true
        default: "enter/your-repo-here"
      org_name:
        description: "The name of the organization to search within"
        required: true
        default: "enter-your-organization"

jobs:
  search-for-usages:
    runs-on: ubuntu-latest
    steps:
      - name: Use GitHub CLI to search for submodule references
        env:
          GH_TOKEN: ${{ secrets.YOUR_PAT_TOKEN }} # PAT with repo scope or org read access
          SUBMODULE_REPO: ${{ github.event.inputs.submodule_repo }}
          ORG_NAME: ${{ github.event.inputs.org_name }}
        run: |
          echo "Searching for repos in $ORG_NAME that use $SUBMODULE_REPO as a submodule..."

          # Use the gh CLI to search for code with the submodule reference in .gitmodules files
          # The search query is constrained to the specific organization
          SEARCH_QUERY="\"$SUBMODULE_REPO\" org:$ORG_NAME filename:.gitmodules"

          # Run the search, format output to get the repository HTML URLs, and remove duplicates
          # Note: GitHub CLI might return less results than the UI search (API limitation)
          RESULTS=$(gh search code "$SEARCH_QUERY" --json repository | jq -r '.[] | .repository.htmlUrl' | sort | uniq)

          if [ -z "$RESULTS" ]; then
            echo "No repositories found using $SUBMODULE_REPO as a submodule in $ORG_NAME."
          else
            echo "Found repositories:"
            echo "$RESULTS"
            # Optional: Save results to an artifact or issue comment
          fi
