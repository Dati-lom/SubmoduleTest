name: Update Dependent Submodules

on:
  push:
    branches:
      - main

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Discover dependent repositories
        id: discover
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const fullRepoName = `${owner}/${repo}`;

            // Try multiple search approaches
            const searchQueries = [
              `"${fullRepoName}" in:file path:.gitmodules`,
              `${fullRepoName} filename:.gitmodules`,
              `"${fullRepoName}" extension:gitmodules`
            ];

            let allDependents = new Set();

            for (const searchQuery of searchQueries) {
              try {
                console.log(`Searching with query: ${searchQuery}`);
                
                const searchResults = await github.rest.search.code({
                  q: searchQuery,
                  per_page: 100
                });
                
                console.log(`Found ${searchResults.data.total_count} results`);
                
                searchResults.data.items.forEach(item => {
                  console.log(`  - ${item.repository.full_name} (${item.path})`);
                  allDependents.add(item.repository.full_name);
                });
                
              } catch (error) {
                console.log(`Error with query "${searchQuery}":`, error.message);
                if (error.status === 403) {
                  console.log('Rate limit hit or authentication issue');
                }
              }
            }

            const dependents = Array.from(allDependents);
            console.log('\nFinal list of dependent repositories:', dependents);

            if (dependents.length === 0) {
              console.log('\n!!!!!  No dependent repositories found. This could mean:');
              console.log('  1. No repositories actually use this as a submodule');
              console.log('  2. The .gitmodules files are not yet indexed by GitHub');
              console.log('  3. The PAT_TOKEN lacks required permissions');
              console.log('  4. The repositories are private and not accessible');
            }

            core.setOutput('repos', JSON.stringify(dependents));

      - name: Update each dependent repository
        if: steps.discover.outputs.repos != '[]'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_BRANCH: staging
        run: |
          dependents='${{ steps.discover.outputs.repos }}'

          if [ "$dependents" = "[]" ]; then
            echo "No dependent repositories to update"
            exit 0
          fi

          echo "$dependents" | jq -r '.[]' | while read repo; do
            echo "Processing $repo..."
            
            # Clone the dependent repo
            if ! git clone "https://x-access-token:${GH_TOKEN}@github.com/${repo}.git" temp-repo; then
              echo "❌ Failed to clone $repo"
              continue
            fi
            
            cd temp-repo
            
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Check if staging branch exists, create if not
            if git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "$TARGET_BRANCH"; then
              echo "Checking out existing $TARGET_BRANCH branch"
              git checkout "$TARGET_BRANCH"
            else
              echo "Creating new $TARGET_BRANCH branch"
              git checkout -b "$TARGET_BRANCH"
            fi
            
            # Update submodules
            git submodule update --init --recursive --remote
            
            # Check if there are changes
            if ! git diff --quiet || ! git diff --staged --quiet; then
              git add .
              git commit -m "chore: update submodule $GITHUB_REPOSITORY to ${GITHUB_SHA:0:7}"
              git push origin "$TARGET_BRANCH"
              echo "✓ Updated $repo on $TARGET_BRANCH branch"
            else
              echo "→ No changes needed for $repo"
            fi
            
            cd ..
            rm -rf temp-repo
          done
